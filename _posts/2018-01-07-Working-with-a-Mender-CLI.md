---
layout: post
title: Working with a Mender CLI
description: "Using a python command line interface to Mender"
date: 2018-01-07 14:00:00
categories: linux 
tags: [mender, linux, wandboard, yocto]
---

I came across cool Python tool called [mender-backend-cli][mender-backend-cli] for working with the [Mender][mender-io] server from a command line.

It solves the problem on how to upload [upgrade artifacts][mender-artifacts] built on a server without a GUI.

Until now I have been manually moving the **artifacts** to a workstation first then using a browser to upload with Mender's web interface.

First a little background for the example that follows.

I am testing with some [Wandboards][wandboard] using Yocto built systems as described [here][mender-wandboard].

I am running a [mender server][mender-server-repo] on my local LAN on a machine called **fractal.jumpnow**. I have a local DNS server.

The mender server is setup using the [production installation][mender-production-installation] instructions.

The one exception to the instructions is a small patch to the mender-server [keygen script][mender-server-keygen] to add **SubjectAltName** entries to the certs. Otherwise python belches annoying warnings at every invocation. The patch is not necessary but explains why you might see more warnings then I am showing in the examples. The patch is at the bottom of this post.

I cloned the **mender-backend-cli** and am running it from that location. I didn't bother installing.

Typical python requests module stuff, export an environment variable so local certs are accepted. Point it at the **server.crt** generated by the **keygen** script. The same **server.crt** used in the mender recipe to be installed onto devices.

    ~/mender/mender-backend-cli$ export REQUESTS_CA_BUNDLE=/home/scott/mender/mender-server/production/keys-generated/certs/server.crt

I already have a user account on the mender server, so I am logging in with that

    ~/mender/mender-backend-cli$ ./mender-backend -s https://fractal.jumpnow user login -u scott@jumpnowtek.com -p <some-password>
    INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): fractal.jumpnow
    INFO:root:request successful
    INFO:root:token: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1MTU5NDczNjYsImp0aSI6ImUwZmRjMGViLTc2ZGItNDNlZS1hYTU3LTVmYTc1MzkxZTZhOCIsImlzcyI6Im1lbmRlci51c2VyYWRtIiwic3ViIjoiZDc2MjdiMWYtNzIyMi00MDk0LThkYzktYmYwYWU0ZmQyZTE3Iiwic2NwIjoibWVuZGVyLioiLCJtZW5kZXIudXNlciI6dHJ1ZX0.nWi1HqnnX30Yis-v2VaNwytcFW6rkwYhhsZWK5MPOwqENyCEcUiA395CKIQdn-yrshzItIvwZ_-YVMu0Xn0lKvPWm_KSuOX58cp2n2A6NfdmbacN3UZnUfWCYozJKgkt6h85YBEP9JdLrLhcHkMuPwAbZtuXWXTDJ2oDGiagJk-4ZB3TOHlT4neYOEbffdTqleREXdZ9enQ6liyWBbsx1PEMV2XWra9LBX72V_0NGbT7WsJ4S8MDGfGl9klfxhKW38jluVroTygj5AmagFf-y61tGR8jb_Ps-y45sNSLjZhwReTitmATO2gl7sxAkNrVZjAJZKfoSd_0ERtcsVl5CQ1CPbEZqmbi5gI6NHNSgfRyOpd3XNkLC6z3hOUdW2XAaBIHhUK0ice2L8qY2mspywU1vIRnO29GgfIMHmp8CyvS_FaLVi6S4AfFNz4ZI39h52kjKF1krp0dvkd8yhpJJ-Q24r0mQf7yNU8gkFt6VdGJ6MNKJv9RZMFl7fXlq3NX

That command created  a **usertoken** file in the local directory that gets used automatically by later commands.

    scott@fractal:~/mender/mender-backend-cli$ ls -l usertoken
    -rw-rw-r-- 1 scott scott 773 Jan  7 11:29 usertoken


The **--help** command works really well with any of the commands I have tried.

I will just show a few things.

Here is a list of devices.

    ~/mender/mender-backend-cli$ ./mender-backend -s https://fractal.jumpnow inventory device list
    INFO:root:loading user token from usertoken
    INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): fractal.jumpnow
    devices:
      5a5246cb41e7a20001c53907 (type: wandboard, updated: 2018-01-07T16:30:26.193Z)
      5a5248f441e7a20001c5390b (type: wandboard, updated: 2018-01-07T16:30:10.718Z)

Only two devices using this server instance.

Some more details on the first device
  
    ~/mender/mender-backend-cli$ ./mender-backend -s https://fractal.jumpnow inventory device show 5a5246cb41e7a20001c53907
    INFO:root:loading user token from usertoken
    INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): fractal.jumpnow
    {
        "updated_ts": "2018-01-07T16:33:26.194Z",
        "attributes": [
            {
                "value": "ARMv7 Processor rev 10 (v7l)",
                "name": "cpu_model"
            },
            {
                "value": "wandq-test-1",
                "name": "artifact_name"
            },
            {
                "value": "fe80::21f:7bff:feb4:379/64",
                "name": "ipv6_eth0"
            },
            {
                "value": "2063828",
                "name": "mem_total_kB"
            },
            {
                "value": "Linux version 4.14.12-jumpnow (oe-user@oe-host) (gcc version 7.2.0 (GCC))  #2 SMP Sun Jan 7 10:58:15 EST 2018",
                "name": "kernel"
            },
            {
                "value": "wandboard",
                "name": "device_type"
            },
            {
                "value": "00:1f:7b:b4:03:79",
                "name": "mac_eth0"
            },
            {
                "value": "wandboard",
                "name": "hostname"
            },
            {
                "value": "eth0",
                "name": "network_interfaces"
            },
            {
                "value": "192.168.10.220/24",
                "name": "ipv4_eth0"
            },
            {
                "value": "1.3.0",
                "name": "mender_client_version"
            }
        ],
        "id": "5a5246cb41e7a20001c53907"
    }
    attributes:
      artifact_name       : wandq-test-1
      cpu_model           : ARMv7 Processor rev 10 (v7l)
      device_type         : wandboard
      hostname            : wandboard
      ipv4_eth0           : 192.168.10.220/24
      ipv6_eth0           : fe80::21f:7bff:feb4:379/64
      kernel              : Linux version 4.14.12-jumpnow (oe-user@oe-host) (gcc version 7.2.0 (GCC)) #2 SMP Sun Jan 7 10:58:15 EST 2018
      mac_eth0            : 00:1f:7b:b4:03:79
      mem_total_kB        : 2063828
      mender_client_version: 1.3.0
      network_interfaces  : eth0
    last update: 2018-01-07T16:33:26.194Z

I built a new artifact and then signed it using the **sign-mender-image.sh** in **meta-wandboard**

    ~/wand-mender/meta-wandboard/scripts$ export TOPDIR=~/wand-mender
    ~/wand-mender/meta-wandboard/scripts$ ./sign-mender-image.sh
    Creating artifact using the following parameters
    TMPDIR: /oe8/wandm/tmp-rocko
    Artifact name: wandq-test-3
    Private key: /home/scott/wand-mender/mender-keys/private.key
    Public key: /home/scott/wand-mender/mender-keys/public.key
    Source: /oe8/wandm/tmp-rocko/deploy/images/wandboard/mender-test-image-wandboard.ext4

    Running mender-artifact to create signed artifact

    Wrote artifact to /home/scott/wand-mender/upload/wandq-test-3-signed.mender
    Checking artifact

    Mender artifact:
      Name: wandq-test-3
      Format: mender
      Version: 2
      Signature: signed and verified correctly
      Compatible devices: '[wandboard]'

    Updates:
      0000:
        Type:   rootfs-image
        Files:
          name:     mender-test-image-wandboard.ext4
          size:     1073741824
          modified: 2018-01-07 12:47:02 -0500 EST
          checksum: 4e5afd04164c4474d243211a5909902e6b4a93194b675083329c00f60f3ce547


So now I can use **mender-backend** to upload the artifact

    ~/mender/mender-backend-cli$ ./mender-backend -s https://fractal.jumpnow artifact add -n wandq-test-3 -e 'another cli test' ~/wand-mender/upload/wandq-test-3-signed.mender
    INFO:root:loading user token from usertoken67 - 00:00:00
    INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): fractal.jumpnow
    created with URL: ./management/v1/deployments/artifacts/f0bae668-8c79-440f-b3b5-5d36ec8fa9f9
    artifact ID:  f0bae668-8c79-440f-b3b5-5d36ec8fa9f9


And now checking that indeed it got there.

    ~/mender/mender-backend-cli$ ./mender-backend -s https://fractal.jumpnow artifact list
    INFO:root:loading user token from usertoken
    INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): fractal.jumpnow
    [
        {
            "description": "cli test",
            "id": "fba94c06-200b-4e3c-84b2-f41c01a7ee2b",
            "modified": "2018-01-07T16:36:24.708Z",
            "info": {
                "version": 2,
                "format": "mender"
            },
            "name": "wandq-test-2",
            "signed": true,
            "updates": [
                {
                    "files": [
                        {
                            "size": 1073741824,
                            "date": "2018-01-07T16:26:09Z",
                            "name": "mender-test-image-wandboard.ext4",
                            "checksum": "c45638afa99690e4b08c0740a3240e32e8ce8f81d5022953dbfdd11b8e07ab96"
                        }
                    ],
                    "type_info": {
                        "type": "rootfs-image"
                    }
                }
            ],
            "device_types_compatible": [
                "wandboard"
            ]
        },
        {
            "description": "another cli test",
            "id": "f0bae668-8c79-440f-b3b5-5d36ec8fa9f9",
            "modified": "2018-01-07T17:51:04.264Z",
            "info": {
                "version": 2,
                "format": "mender"
            },
            "name": "wandq-test-3",
            "signed": true,
            "updates": [
                {
                    "files": [
                        {
                            "size": 1073741824,
                            "date": "2018-01-07T17:47:02Z",
                            "name": "mender-test-image-wandboard.ext4",
                            "checksum": "4e5afd04164c4474d243211a5909902e6b4a93194b675083329c00f60f3ce547"
                        }
                    ],
                    "type_info": {
                        "type": "rootfs-image"
                    }
                }
            ],
            "device_types_compatible": [
                "wandboard"
            ]
        }
    ]


And here is a deployment of the new artifact

The first device

    scott@fractal:~/mender/mender-backend-cli$ ./mender-backend -s https://fractal.jumpnow deployment add -a 'wandq-test-3' -e '5a5246cb41e7a20001c53907' -n 'test'
    INFO:root:loading user token from usertoken
    INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): fractal.jumpnow
    created with URL: ./management/v1/deployments/deployments/57fbfadf-8806-4f66-bf24-06d336b0569a
    deployment ID:  57fbfadf-8806-4f66-bf24-06d336b0569a

The second device

    scott@fractal:~/mender/mender-backend-cli$ ./mender-backend -s https://fractal.jumpnow deployment add -a 'wandq-test-3' -e '5a5248f441e7a20001c5390b' -n 'another test'
    INFO:root:loading user token from usertoken
    INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): fractal.jumpnow
    created with URL: ./management/v1/deployments/deployments/df62367d-5cf7-4bca-aef0-39bd2549b125
    deployment ID:  df62367d-5cf7-4bca-aef0-39bd2549b125


Obviously a **group deployment** would be preferred. Not sure how to do that yet.., but since this is now scriptable it doesn't really matter.

This is a very cool tool.
 

### keygen patch

This keeps both python and browsers from complaining about the missing **SubjectAltName** entry from the certs generated by the mender-server **keygen** script.

The details on how to add **SubjectAltName** in a one-liner came from this [StackExchange][stackexchange-post] post.


Here's the two line patch

    commit 4c4c36d25ef2c64554a7ff7aa7c87de6b17af329
    Author: Scott Ellis <scott@jumpnowtek.com>
    Date:   Sun Jan 7 09:40:13 2018 -0500

        keygen: Add SubjectAltName to certs

    diff --git a/keygen b/keygen
    index 25ec8aa..0ccc5b2 100755
    --- a/keygen
    +++ b/keygen
    @@ -40,11 +40,21 @@ cd $CERTDIR
     mkdir api-gateway storage-proxy

     cd api-gateway
    -openssl req -x509 -sha256 -nodes -days $CERT_VALID_DAYS -newkey ec:<(openssl ecparam -name prime256v1) -keyout $FILE_NAME_PRIVATE_KEY -out $FILE_NAME_CERT -subj /CN=$CERT_API_CN
    +if [ -n ${CERT_API_SAN} ]; then
    +  openssl req -x509 -sha256 -nodes -days $CERT_VALID_DAYS -newkey ec:<(openssl ecparam -name prime256v1) -keyout $FILE_NAME_PRIVATE_KEY -out $FILE_NAME_CERT -subj /CN=$CERT_API_CN \
    +    -extensions SAN -config <(cat /etc/ssl/openssl.cnf <(printf "\n[SAN]\nsubjectAltName=${CERT_API_SAN}"))
    +else
    +  openssl req -x509 -sha256 -nodes -days $CERT_VALID_DAYS -newkey ec:<(openssl ecparam -name prime256v1) -keyout $FILE_NAME_PRIVATE_KEY -out $FILE_NAME_CERT -subj /CN=$CERT_API_CN
    +fi
     cd ..

     cd storage-proxy
    -openssl req -x509 -sha256 -nodes -days $CERT_VALID_DAYS -newkey ec:<(openssl ecparam -name prime256v1) -keyout $FILE_NAME_PRIVATE_KEY -out $FILE_NAME_CERT -subj /CN=$CERT_STORAGE_CN
    +if [ -n ${CERT_STORAGE_SAN} ]; then
    +  openssl req -x509 -sha256 -nodes -days $CERT_VALID_DAYS -newkey ec:<(openssl ecparam -name prime256v1) -keyout $FILE_NAME_PRIVATE_KEY -out $FILE_NAME_CERT -subj /CN=$CERT_STORAGE_CN \
    +    -extensions SAN -config <(cat /etc/ssl/openssl.cnf <(printf "\n[SAN]\nsubjectAltName=${CERT_STORAGE_SAN}"))
    +else
    +  openssl req -x509 -sha256 -nodes -days $CERT_VALID_DAYS -newkey ec:<(openssl ecparam -name prime256v1) -keyout $FILE_NAME_PRIVATE_KEY -out $FILE_NAME_CERT -subj /CN=$CERT_STORAGE_CN
    +fi
     cd ..

     # concatenate the certificates for inclusion on the Mender client


Now when running the [keygen][mender-server-keygen] script instead of this command

    CERT_API_CN=fractal.jumpnow CERT_STORAGE_CN=fractal.jumpnow ../keygen

I am using this instead

    CERT_API_CN=fractal.jumpnow CERT_API_SAN=DNS:fractal.jumpnow CERT_STORAGE_CN=fractal.jumpnow CERT_STORAGE_SAN=DNS:fractal.jumpnow ../keygen


[mender-backend-cli]: https://github.com/bboozzoo/mender-backend-cli
[mender-io]: https://mender.io/what-is-mender
[mender-artifacts]: https://docs.mender.io/1.3/architecture/mender-artifacts
[wandboard]: http://www.wandboard.org/
[mender-wandboard]: http://www.jumpnowtek.com/wandboard/Adding-Mender-to-a-Wandboard-System.html
[mender-production-installation]: https://docs.mender.io/1.3/administration/production-installation
[stackexchange-post]: https://security.stackexchange.com/questions/74345/provide-subjectaltname-to-openssl-directly-on-command-line
[mender-server-repo]: https://github.com/mendersoftware/integration
[mender-server-keygen]: https://github.com/mendersoftware/integration/blob/master/keygen
 